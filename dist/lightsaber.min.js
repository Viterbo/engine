!function(t){function e(t){this.init(t)}e.utils={},e.utils.$=window.$||window.jQuery||("undefined"!=typeof angular?angular.element:null)||("undefined"!=typeof jwk?jwk.query:null)||window.TreeQuery,e.utils.Deferred=e.utils.$.Deferred||("undefined"!=typeof jwk?jwk.Deferred:null),e.utils.extend=e.utils.$.extend||("undefined"!=typeof angular?angular.extend:null)||("undefined"!=typeof jwk?jwk.extend:null),e.prototype={constructor:e,tweenable_properties:{alpha:!0},init:function(t){this._settings=e.utils.extend({height:600,width:800,container_id:"",full_document:!0,auto_resize:!0,section:"/"},t),this._settings.spec&&this.create(this._settings.spec)},create:function(t){var i=this;this.clear(),this.engine=new e.Engine(e.utils.extend(t,{callbacks:this._settings}),i),this.engine._ls_start().done(function(){i._settings.auto_resize&&(i.engine._game.renderer.autoResize=!0,window.onresize=i.resize.bind(i),i.enter_section(i._settings.section))})},clear:function(){},resize:function(){var t=window.innerHeight,e=window.innerWidth;this.engine&&this.engine._ls_resize(e,t)},enter_section:function(t){this._section=t,this.update_spec(),this.resize()},update_spec:function(t){this.engine&&this.engine._ls_update_spec()},create_handler:function(t){var e=this;return function(i,s){switch(i.spec[t].handler){case"scene-enter-section":e.enter_section(i.spec[t].params)}}},extend_spec:function(t){function i(t,e){if("/"==t)e(t);else{var s=t.split("/");s.pop();var a=s.join("/");""==a&&(a="/"),i(a,e),e(t)}}var s=this,a=e.utils.extend({},t),h=[];if(t["class"]){"string"==typeof t["class"]&&(t["class"]=t["class"].split(" ")),console.assert(Array.isArray(t["class"]),t["class"]),console.assert(this._settings.spec["class"],this._settings.spec["class"]);for(var n in t["class"]){var r=t["class"][n],o=this._settings.spec["class"][r],d=this.extend_spec(o);a=e.utils.extend(a,d),h.push(r)}a["class"]=h}return t.instance_name&&this._section&&this._settings.spec.scene.sections&&i(this._section,function(i){var h=s._settings.spec.scene.sections[i];if(h&&h[t.instance_name]){var n=h[t.instance_name];n=s.extend_spec(n),a=e.utils.extend(a,n)}}),a}},e.DisplayObject=function(t,e,i){console.log("spec.texture",e.texture),Phaser.Sprite.call(this,t,0,0,e.texture),this.game=t,this.spec=e,this.data=e,this.state={x:0,y:0,width:123,height:456},this.instance_name=e.instance_name,this._ls_parent=i,i&&this.game.world.addChild(this),this.subscribeToEvents(),this.createChildren(),this.sortChildren()},e.DisplayObject.prototype=e.utils.extend(Object.create(Phaser.Sprite.prototype),{constructor:e.DisplayObject,getDependencies:function(){var t=[];if(this.data.position&&t.push(this.data.position.of),this.data.anchors)for(var e in this.data.anchors)t.push(this.data.anchors[e].of);return t},sortChildren:function(){console.assert(this._ls_children,"ERROR: this._ls_children does't exist");for(var t=0,e=this._ls_children.map(function(t){return t}),i={},s=[],a=100;e.length>0;){if(a--<0){console.error("ERROR: infinite dependency loop");break}var h=e.shift(),n=h.getDependencies();console.assert("string"==typeof h.spec.instance_name,"ERROR: child.spec.instance_name is not a string",h),i[h.spec.instance_name]=!0;for(var r=0;r<n.length;r++)if("parent"!=n[r]&&(t=n[r].indexOf("parent."),0==t)){var o=n[r].substr(7);o in i||(i[h.spec.instance_name]=!1,e.push(h))}i[h.spec.instance_name]&&s.push(h)}console.assert(this._ls_children.length==s.length,"ERROR: some child lost in the sorting proccess"),this._ls_children=s},createChildren:function(){console.assert(this.data,"ERROR: this.data does't exist"),this._ls_children=[];for(var t in this.data.children){var i=this.data.children[t];i.instance_name=t,i=this.game.saber.extend_spec(i);var s=null,a=e[i.type];console.assert(a,"ERROR: type not found: ",i.type,[i]),s=new a(this.game,i,this),s._ls_parent=this,this._ls_children.push(s)}},subscribeToEvents:function(){for(var t in this.spec){var e=this.spec[t];switch(t){case"onInputOver":case"onInputDown":var i=this.game.saber.create_handler(t,e);this.inputEnabled=!0,this.events[t].add(i,this);break;default:0==t.indexOf("on")&&console.warn("WARNING: if not an event handler, dont use 'on' as a prefix. property found: ",t)}}},update_spec:function(){console.assert(this._ls_children,"ERROR: this._ls_children does't exist"),this.data=this.game.saber.extend_spec(this.spec);for(var t in this.data)t in this.game.saber.tweenable_properties&&this.data[t]!=this.state[t]&&(this.state[t]=this.data[t]);for(var e=0;e<this._ls_children.length;e++)this._ls_children[e].update_spec()},childrenDoCreate:function(){console.assert(this._ls_children,"ERROR: this._ls_children does't exist");for(var t=0;t<this._ls_children.length;t++)this._ls_children[t].create()},getChild:function(t){for(var e=0;e<this._ls_children.length;e++)if(this._ls_children[e].instance_name==t)return this._ls_children[e];console.error("ERROR: no child with name '"+t+"' was found",this._ls_children)},translateToCoords:function(t){var e,i,s,a;console.assert("string"==typeof t,"ERROR: str must be a string. got: ",typeof t);var h=t.split(" ");switch(console.assert(2==h.length,"ERROR: str MUST have two expresions separated by one space. got: ",t),h[0]){case"top":a=0;break;case"middle":a=.5;break;case"bottom":a=1;break;case"center":a=.5,console.error("ERROR: use 'middle' instead of 'center' for vertical aligment");break;default:a=-1!=h[0].indexOf("%")?.01*parseInt(h[0].substr(0,h[0].indexOf("%"))):h[0]/this.state.height}switch(h[1]){case"left":s=0;break;case"center":s=.5;break;case"right":s=1;break;default:s=-1!=h[1].indexOf("%")?.01*parseInt(h[1].substr(0,h[1].indexOf("%"))):h[1]/this.state.width}return e=this.state.x+this.state.width*s,i=this.state.y+this.state.height*a,{x:e,y:i,ox:s,oy:a}},setDeployment:function(t){this.setSize(t),this.setPosition(t)},updateDeployment:function(){return this.computeDeployment(!0),this},computeDeployment:function(t){console.debug("DisplayObject.computeDeployment("+t+")");var e={width:12,height:34},i={};if(this.data.width)if("string"==typeof this.data.width&&-1!=this.data.width.indexOf("%")){var s=parseFloat(this.data.width.substr(0,this.data.width.indexOf("%")));e.width=s*this._ls_parent.state.width/100}else e.width=parseInt(this.data.width);if(this.data.maxWidth){if("string"==typeof this.data.maxWidth&&-1!=this.data.maxWidth.indexOf("%")){var s=parseFloat(this.data.maxWidth.substr(0,this.data.maxWidth.indexOf("%")));e.maxWidth=s*this._ls_parent.state.width/100}else e.maxWidth=parseInt(this.data.maxWidth);e.width=Math.min(e.maxWidth,e.width)}if(this.data.minWidth){if("string"==typeof this.data.minWidth&&-1!=this.data.minWidth.indexOf("%")){var s=parseFloat(this.data.minWidth.substr(0,this.data.minWidth.indexOf("%")));e.minWidth=s*this._ls_parent.state.width/100}else e.minWidth=parseInt(this.data.minWidth);e.width=Math.max(e.minWidth,e.width)}if(this.data.height)if("string"==typeof this.data.height&&-1!=this.data.height.indexOf("%")){var a=parseFloat(this.data.height.substr(0,this.data.height.indexOf("%")));e.height=a*this._ls_parent.state.height/100}else e.height=parseInt(this.data.height);if(this.data.maxHeight){if("string"==typeof this.data.maxHeight&&-1!=this.data.maxHeight.indexOf("%")){var a=parseFloat(this.data.maxHeight.substr(0,this.data.maxHeight.indexOf("%")));e.maxHeight=a*this._ls_parent.state.height/100}else e.maxHeight=parseInt(this.data.maxHeight);e.height=Math.min(e.maxHeight,e.height)}if(this.data.minHeight){if("string"==typeof this.data.minHeight&&-1!=this.data.minHeight.indexOf("%")){var a=parseFloat(this.data.minHeight.substr(0,this.data.minHeight.indexOf("%")));e.minHeight=a*this._ls_parent.state.height/100}else e.minHeight=parseInt(this.data.minHeight);e.height=Math.max(e.minHeight,e.height)}if(t?this.setSize(e):(i={width:this.state.width,height:this.state.height,x:this.state.x,y:this.state.y},this.state.width=e.width,this.state.height=e.height),this.data.position){console.assert("string"==typeof this.data.position.of,"ERROR: position MUST have a 'of' attribute referencing a valid object"),console.assert("string"==typeof this.data.position.at,"ERROR: position MUST have a 'at' attribute referencing a valid object");var h=this._ls_parent,n=this.data.position.of.indexOf("parent.");-1!=n&&(h=this._ls_parent.getChild(this.data.position.of.substr("parent.".length))),this.state.y=this.state.x=0;var r=this.translateToCoords(this.data.position.my),o=h.translateToCoords(this.data.position.at);e.x=o.x-r.x,e.y=o.y-r.y}if(this.data.anchors){console.assert(2==this.data.anchors.length,"ERROR: anchors MUST be an array-like object width 2 objects containing {my, at, of} map each");var h=[this._ls_parent,this._ls_parent],n=[],r=[],o=[];this.y=this.x=0;for(var d=0;2>d;d++)n[d]=this.data.anchors[d].of.indexOf("parent."),-1!=n[d]&&(h[d]=this._ls_parent.getChild(this.data.anchors[d].of.substr("parent.".length))),r[d]=this.translateToCoords(this.data.anchors[d].my),o[d]=h[d].translateToCoords(this.data.anchors[d].at);e.width=Math.abs(o[0].x-o[1].x),e.x=o[0].x-e.width*r[0].ox,e.height=Math.abs(o[0].y-o[1].y),e.y=o[0].y-e.width*r[0].ox,t&&this.setSize(e)}return t?this.setPosition(e):this.setPosition(i),e},setSize:function(t){this.state.width=t.width,this.state.height=t.height,this._update_state_use_tween=this._update_not_first_time&&!isNaN(t.width)&&!isNaN(t.height)&&this.spec.tween,this._update_state=!0},setPosition:function(t){this.state.y=t.y,this.state.x=t.x,this._update_state_use_tween=this._update_not_first_time&&!isNaN(t.x)&&!isNaN(t.y)&&this.spec.tween,this._update_state=!0},resize:function(){this.updateDeployment();for(var t in this._ls_children)this._ls_children[t].resize()},update:function(){if(this._update_state)if(this._update_state=!1,this._update_not_first_time=!0,this._update_state_use_tween){this.game.add.tween(this).to(this.state,this.spec.tween.time,this.spec.tween.ease,!0,this.spec.tween.delay)}else console.log("this.state: ",this.state,[this]),e.utils.extend(this,this.state)}}),e.DOM_Wrapper=function(t,i,s){e.DisplayObject.call(this,t,i,s)},e.DOM_Wrapper.prototype=e.utils.extend(Object.create(e.DisplayObject.prototype),{create:function(){var t=e.utils.$;this._$element=t("<div style='position: absolute; display: inline-block;'></div>").append(this.spec.html).appendTo("body"),this._$canvas_view=t(this.game.renderer.view),this.childrenDoCreate()},update:function(){e.DisplayObject.prototype.update.call(this);var t=null;(this._last_parent_x!=this.parent.x||this._last_parent_y!=this.parent.y||this._last_self_x!=this.x||this._last_self_y!=this.y)&&(this._last_parent_x=this.parent.x,this._last_parent_y=this.parent.y,this._last_self_x=this.x,this._last_self_y=this.y,t=this._$canvas_view.offset(),t.top+=this.y+this.parent.y,t.left+=this.x+this.parent.x,this._$element[0].style.top=t.top+"px",this._$element[0].style.left=t.left+"px");var t=null;if((this._last_width!=this.width||this._last_height!=this.height)&&(this._last_width=this.width,this._last_height=this.height,this._$element.width(this.width),this._$element.height(this.height)),this._last_angle!=this.angle){this._last_angle=this.angle;var i=100*(this.anchor.x-.5),s=100*(this.anchor.y-.5),a=100*this.anchor.x,h=100*this.anchor.y,n="translate("+i+"%,"+s+"%) translate(-"+a+"%,-"+h+"%) rotate("+this.angle+"deg) translate("+-i+"%,"+-s+"%)";this._$element[0].style.transform=n}(this._last_alpha!=this.alpha||this._last_alpha!=this.alpha)&&(this._last_alpha=this.alpha,this._$element.css("opacity",this.alpha))},resize:function(){e.DisplayObject.prototype.resize.call(this)}}),e.DOM_Wrapper.install=function(t){t.make.domWrapper=function(i,s,a,h,n,r,o){return new e.DOM_Wrapper(t,i,s,a,h,n,r,o)},t.add.domWrapper=function(e,i,s,a,h,n,r,o){void 0===o&&(o=t.world);var d=t.make.domWrapper(e,i,s,a,h,n,r);return o.add(d),d}},e.utils.hexToRgb=function(t){var e=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;t=t.replace(e,function(t,e,i,s){return e+e+i+i+s+s});var i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null},e.Engine=function(t,i){this._spec=t,this._callbacks=t.callbacks,this._boot_deferred=e.utils.Deferred(),this._boot_deferred_pending=!0;var s=this;this.saber=i,this._boot_deferred.promise().done(function(){s._boot_deferred_pending=!1})},LightSaber_Engine_prototype={constructor:e.Engine,_ls_resize:function(t,e){var i=new Phaser.Rectangle(0,0,t,e);this._game.renderer.view.style.position="absolute",this._game.renderer.view.style.top="0px",this._game.renderer.view.style.left="0px",this._game.renderer.resize(t,e),1===this._game.renderType&&Phaser.Canvas.setSmoothingEnabled(this._game.context,!1),this._game.camera.setSize(t,e),this._game.camera.bounds=i,this._game.world.bounds=i,this._game.width=t,this._game.height=e,this._game.stage.width=t,this._game.stage.height=e,this.scene.resize()},_ls_start:function(){return console.log("_ls_start"),this._game=new Phaser.Game(this._spec.width,this._spec.height,Phaser.AUTO,this._spec.container_id),this._game.saber=this.saber,this._game.state.add("LightSaber",this),this._game.state.start("LightSaber"),this._boot_deferred.promise()},preload:function(){console.log("preload()");for(var t in this._spec.preload)this.game.load.image(t,this._spec.preload[t])},_ls_update_spec:function(){this.scene.update_spec()},_create_scene:function(){console.log("_create_scene()"),this.scene=new e.Scene(this.game,this._data.scene)},_parse_gamejson:function(t){if(this._data=t,"string"==typeof this._data)try{this._data=JSON.parse(this._data)}catch(e){return console.error("ERROR: gamejson must be a plane map object or a valid json string. ",t),!1}return!0},create:function(){console.log("create()",this._spec),this._parse_gamejson(this._spec)?(console.assert(this._data,"ERROR: this._data not set"),this._create_scene()):console.warn("WARNING: this._data not set properly"),"function"==typeof this._callbacks.create&&this._callbacks.create(this._game)},render:function(){"function"==typeof this._callbacks.render&&this._callbacks.render(this._game)},update:function(){this._boot_deferred_pending&&this._boot_deferred.resolve(),"function"==typeof this._callbacks.update&&this._callbacks.update(this._game)},resize:function(){console.log("resize()")}},e.Engine.prototype=LightSaber_Engine_prototype,e.YoutubeVideo=function(t,i,s){console.log("LightSaber.YoutubeVideo");var a="autoplay="+(i.autoplay?"1":"0"),h="allowfullscreen='"+(i.allowfullscreen?"true":"false")+"'",n="<iframe frameborder='0' "+h+" style='height:100%; width:100%'src='https://www.youtube.com/embed/",r="?feature=oembed&amp;"+a+"&amp;wmode=opaque&amp;rel=0&amp;showinfo=0&amp;modestbranding=0&amp;fs=1'></iframe>",o=n+i.videoid+r;i.html=o,e.DOM_Wrapper.call(this,t,i,s)},e.YoutubeVideo.prototype=e.utils.extend(Object.create(e.DOM_Wrapper.prototype),{}),e.Sprite=function(t,e,i){console.log("spec.texture",e.texture),Phaser.Sprite.call(this,t,0,0,e.texture),this.game=t,this.spec=e,this.data=e,this.state={x:0,y:0,width:123,height:456},this.instance_name=e.instance_name,this._ls_parent=i,i&&this.game.world.addChild(this),this.subscribeToEvents(),this.createChildren(),this.sortChildren()},e.Sprite.prototype=e.utils.extend(Object.create(e.DisplayObject.prototype),{create:function(){this.mask=this.game.add.graphics(0,0),this.mask.beginFill(16711680),this.mask.drawRect(0,0,this.texture.width,this.texture.height),this.texture_size={h:this.texture.height,w:this.texture.width},this.aspectRatio=this.texture_size.w/this.texture_size.h,this.childrenDoCreate()},computeDeployment:function(t){var i=e.DisplayObject.prototype.computeDeployment.call(this,!1);console.debug("Sprite.computeDeployment("+t+")");var s,a;this.scale.x=1,this.scale.y=1;var h=this.spec["texture-size"];switch(h){case"cover":i.mask={x:i.x,y:i.y,width:i.width,height:i.height},this.aspectRatio<=i.width/i.height?(s=i.width/this.aspectRatio,a=.5*(s-i.height)/s,i.y-=.5*(s-i.height),i.height=s):(s=i.height*this.aspectRatio,i.x-=.5*(s-i.width),i.width=s);break;case"contain":this.aspectRatio<=i.width/i.height?(s=i.height*this.aspectRatio,i.x+=.5*(s-i.width),i.width=s):(s=i.width/this.aspectRatio,i.y+=.5*(s-i.height),i.height=s)}return t&&this.setDeployment(i),i},setDeployment:function(t){console.debug("setDeployment:",t),e.DisplayObject.prototype.setDeployment.call(this,t),t.crop&&(console.log("AAAAAAAAAAAAAAAAAA"),t.crop.x&&(this.cropRect.x=t.crop.x),t.crop.y&&(this.cropRect.y=t.crop.y),t.crop.width&&(this.cropRect.width=t.crop.width),t.crop.height&&(this.cropRect.height=t.crop.height)),t.mask&&this.mask&&(console.log("BBBBBBBBBBBBBBBBB"),this.mask.clear(),this.mask.beginFill(16711680),this.mask.drawRect(t.mask.x,t.mask.y,t.mask.width,t.mask.height),this._bounds=new Phaser.Rectangle(t.mask.x,t.mask.y,t.mask.width,t.mask.height))}}),e.Scene=function(t,i,s){this.data=t.saber.extend_spec(i),e.DisplayObject.call(this,t,i,s),this.width=t.world.width,this.height=t.world.height,this.x=0,this.y=0,this.game.world.addChild(this),this.childrenDoCreate()},e.Scene.prototype=e.utils.extend(Object.create(e.DisplayObject.prototype),{resize:function(){this.state={width:this.game.world.width,height:this.game.world.height,x:0,y:0},this._update_state=!0;for(var t in this._ls_children)this._ls_children[t].resize()}}),e.BitmapData=function(t,i,s){var a={x:22,y:33,width:200,height:200};this.bmd=t.make.bitmapData(a.width,a.height),this.bmd.x=this.bmd.y=0,i.texture=this.bmd,e.DisplayObject.call(this,t,i,s),this.x=a.x,this.y=a.y,this.width=a.width,this.height=a.height},e.BitmapData.prototype=e.utils.extend(Object.create(e.DisplayObject.prototype),{create:function(){console.log("SSSSSSSSSSSSSSS");var t=e.utils.hexToRgb(this.spec.fillStyle);this.bmd.fill(t.r,t.g,t.b),this.childrenDoCreate()},setDeployment:function(t){console.error("ERROR"),this.bmd.width=t.width,this.bmd.height=t.height,e.DisplayObject.prototype.setDeployment.call(this,t)},setSize:function(t){this.bmd.width=t.width,this.bmd.height=t.height,e.DisplayObject.prototype.setSize.call(this,t)}}),"function"==typeof define&&define.amd?define("lightsaber",[],function(){return e}):window.LightSaber=e}();